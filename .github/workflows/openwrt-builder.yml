#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-builder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: ğŸš€ OpenWrt Builder

# ================================================================================
# Trigger Configuration
# ================================================================================
on:
  repository_dispatch:
    types: [Source-Code-Update]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ğŸ› ï¸ Build Type'
        required: false
        default: 'standard'
        type: choice
        options:
        - standard
        - debug
        - minimal
      upload_firmware:
        description: 'ğŸ“¤ Upload Firmware'
        required: false
        default: true
        type: boolean
      upload_release:
        description: 'ğŸ¯ Create Release'
        required: false
        default: true
        type: boolean

# ================================================================================
# Jobs Configuration
# ================================================================================
jobs:
  build:
    name: ğŸ—ï¸ Build OpenWrt Firmware
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
      # ============================================================================
      # Preparation Phase
      # ============================================================================
      - name: ğŸš€ Initialize Build Environment
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}

      - name: ğŸ› ï¸ Load Configuration & Setup Environment
        run: |
          echo "::group::ğŸ”§ Configuration Loading"
          
          # Load configuration from config.env
          if [ -f ".github/workflows/config.env" ]; then
            echo "ğŸ“‹ Loading configuration from config.env..."
            # Source the config file and export all variables
            while IFS='=' read -r key value; do
              # Skip comments and empty lines
              [[ $key =~ ^[[:space:]]*# ]] && continue
              [[ -z $key ]] && continue
              # Remove quotes from value and export
              value=$(echo "$value" | sed 's/^"\(.*\)"$/\1/')
              # Skip empty values
              [[ -z $value ]] && continue
              export "$key=$value"
              echo "$key=$value" >> $GITHUB_ENV
            done < .github/workflows/config.env
            echo "âœ… Configuration loaded successfully"
          else
            echo "âŒ Configuration file not found!"
            exit 1
          fi

          # Set dynamic environment variables
          echo "BUILD_TYPE=${{ github.event_name == 'workflow_dispatch' && 'manual' || 'auto' }}" >> $GITHUB_ENV
          
          # Override upload settings if provided via inputs
          if [ "${{ github.event.inputs.upload_firmware }}" != "" ]; then
            echo "UPLOAD_FIRMWARE=${{ github.event.inputs.upload_firmware }}" >> $GITHUB_ENV
          fi
          if [ "${{ github.event.inputs.upload_release }}" != "" ]; then
            echo "UPLOAD_RELEASE=${{ github.event.inputs.upload_release }}" >> $GITHUB_ENV
          fi
          
          echo "::endgroup::"

      - name: ğŸ“ Setup Configuration Branch
        run: |
          echo "::group::ğŸ”§ Configuration Branch Setup"
          
          # Setup Git configuration
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Clean up any conflicting files
          echo "ğŸ§¹ Cleaning up conflicting files..."
          rm -f op_updates_*.txt qmodem_updates_*.txt *_last_commit.txt 2>/dev/null || true
          
          # Stash any local changes
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "ğŸ’¾ Stashing local changes..."
            git stash push -m "Auto-stash before config branch operations"
          fi
          
          # Check out configuration branch to read existing records
          if git rev-parse --verify origin/$CONFIG_BRANCH >/dev/null 2>&1; then
            echo "ğŸ“‚ Config branch exists, checking out..."
            git fetch origin $CONFIG_BRANCH
            git checkout $CONFIG_BRANCH
            
            # Copy config files to main branch working directory for use during build
            git checkout ${{ github.ref_name }}
            git show $CONFIG_BRANCH:$OP_UPDATES_001 > $OP_UPDATES_001 2>/dev/null || true
            git show $CONFIG_BRANCH:$OP_UPDATES_002 > $OP_UPDATES_002 2>/dev/null || true
            git show $CONFIG_BRANCH:$OP_UPDATES_003 > $OP_UPDATES_003 2>/dev/null || true
            git show $CONFIG_BRANCH:$QMODEM_UPDATES_001 > $QMODEM_UPDATES_001 2>/dev/null || true
            git show $CONFIG_BRANCH:$QMODEM_UPDATES_002 > $QMODEM_UPDATES_002 2>/dev/null || true
            git show $CONFIG_BRANCH:$QMODEM_UPDATES_003 > $QMODEM_UPDATES_003 2>/dev/null || true
          else
            echo "âš ï¸ Config branch does not exist, will be created later"
          fi
          
          echo "âœ… Configuration branch setup completed"
          echo "::endgroup::"

      - name: ğŸ“‹ Display Build Information
        run: |
          echo "::group::ğŸ” Build Configuration"
          echo "ğŸ“… Build Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ·ï¸ Build Type: $BUILD_TYPE"
          echo "ğŸ¯ Trigger: ${{ github.event_name }}"
          echo "ğŸ”§ Runner: $(uname -a)"
          echo "ğŸ“‚ Working Directory: $(pwd)"
          echo "ğŸŒ Repository: ${{ github.repository }}"
          echo "ğŸ“Š Workflow: ${{ github.workflow }}"
          echo "::endgroup::"

      # ============================================================================
      # System Setup Phase
      # ============================================================================
      - name: ğŸ› ï¸ Setup Build Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "::group::ğŸ”§ System Preparation"
          
          echo "ğŸ§¹ Cleaning up system packages..."
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android /opt/ghc
          
          echo "ğŸ“¦ Updating package lists..."
          sudo -E apt-get -qq update
          
          echo "âš™ï¸ Installing build dependencies..."
          if [ -f "$GITHUB_WORKSPACE/depends/ubuntu-22.04" ]; then
            sudo -E apt-get -qq install $(cat $GITHUB_WORKSPACE/depends/ubuntu-22.04)
          else
            echo "âš ï¸ Dependencies file not found, using default packages"
            sudo -E apt-get -qq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          fi
          
          echo "ğŸ Setting up Python environment..."
          if ! command -v pip3 >/dev/null 2>&1; then
            wget -q https://bootstrap.pypa.io/pip/3.6/get-pip.py
            sudo python3 get-pip.py
            sudo rm -f get-pip.py
          fi
          sudo pip3 install pyelftools
          
          echo "::endgroup::"
          
          echo "::group::ğŸ§¹ System Cleanup"
          
          echo "ğŸ³ Cleaning Docker images..."
          docker rmi $(docker images -q) 2>/dev/null || true
          docker image prune -a -f 2>/dev/null || true
          
          echo "ğŸ—‘ï¸ Removing unnecessary packages..."
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* 2>/dev/null || true
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          echo "ğŸ• Setting timezone..."
          sudo timedatectl set-timezone "Asia/Shanghai"
          
          echo "ğŸ“ Creating work directory..."
          sudo mkdir -p /mnt/workdir
          sudo chown $USER:$GROUPS /mnt/workdir
          
          echo "::endgroup::"

      - name: ğŸ“Š System Resource Check
        run: |
          echo "::group::ğŸ’» Hardware Information"
          
          echo "ğŸ”§ CPU Information:"
          echo "  Physical CPUs: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "  CPU Cores: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
          echo ""
          
          echo "ğŸ’¾ Memory Information:"
          echo "  Installed Memory:"
          sudo lshw -short -C memory | grep GiB 2>/dev/null || echo "  Unable to detect memory details"
          echo ""
          
          echo "ğŸ’¿ Disk Information:"
          echo "  Available Disks: $(ls /dev/sd* 2>/dev/null | grep -v [1-9] | wc -l)"
          echo "  Disk Usage:"
          df -hT $PWD
          
          echo "::endgroup::"
          
          # Warn about resource constraints
          available_space=$(df . | tail -1 | awk '{print $4}')
          if [ "$available_space" -lt 20971520 ]; then  # Less than 20GB
            echo "âš ï¸ Warning: Low disk space detected! Available: $(df -h . | tail -1 | awk '{print $4}')"
            echo "::warning::Low disk space may cause build failures"
          fi

      # ============================================================================
      # Source Code Phase
      # ============================================================================
      - name: ğŸ“¥ Clone Source Code
        working-directory: /mnt/workdir
        run: |
          echo "::group::ğŸ“¦ Source Code Acquisition"
          
          echo "ğŸ’¿ Available space before clone:"
          df -hT $PWD
          
          echo "ğŸ”„ Cloning OpenWrt source code..."
          echo "  Repository: $OP_URL"
          echo "  Branch: $OP_BRANCH"
          
          if git clone --depth 1 "$OP_URL" -b "$OP_BRANCH" openwrt; then
            echo "âœ… Successfully cloned OpenWrt source"
          else
            echo "âŒ Failed to clone OpenWrt source"
            exit 1
          fi
          
          # Create symbolic link
          ln -sf /mnt/workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          echo "ğŸ“Š Source code statistics:"
          cd openwrt
          echo "  Commit: $(git rev-parse HEAD)"
          echo "  Author: $(git log -1 --format='%an <%ae>')"
          echo "  Date: $(git log -1 --format='%ci')"
          echo "  Message: $(git log -1 --format='%s')"
          
          echo "ğŸ’¿ Space after clone:"
          df -hT $PWD
          
          echo "::endgroup::"

      # ============================================================================
      # Configuration Tracking Phase
      # ============================================================================
      - name: ğŸ“‹ Update Build Configuration Records
        run: |
          echo "::group::ğŸ“ Configuration Management"
          
          # Get current build information
          current_time=$(date -Iseconds)
          build_type="$BUILD_TYPE"
          
          echo "ğŸ• Build Time: $current_time"
          echo "ğŸ·ï¸ Build Type: $build_type"
          
          # Function to update repository records
          update_repo_records() {
            local repo_url="$1"
            local repo_branch="$2"
            local prefix="$3"
            local display_name="$4"
            
            echo "ğŸ“¦ Updating records for $display_name..."
            
            # Clone repository to get commit info
            if git clone --depth 10 "$repo_url" -b "$repo_branch" "temp_${prefix}"; then
              cd "temp_${prefix}"
              
              # Get commit information
              git log --oneline -10 --format="%H|%h|%s|%an|%ci" > "../commit_list.tmp"
              current_commit=$(git rev-parse HEAD)
              
              cd ..
              rm -rf "temp_${prefix}"
              
              # Rotate update files (003 <- 002 <- 001 <- new)
              if [ -f "${prefix}_updates_002.txt" ]; then
                cp "${prefix}_updates_002.txt" "${prefix}_updates_003.txt"
              fi
              
              if [ -f "${prefix}_updates_001.txt" ]; then
                cp "${prefix}_updates_001.txt" "${prefix}_updates_002.txt"
              fi
              
              # Create new update record
              {
                echo "# $display_name Update Record - Version 001 (Latest)"
                echo "# This file stores the latest update information for $repo_url"
                echo "# Format: commit_hash|short_hash|subject|author|timestamp"
                echo "# Generated: $current_time"
                echo "# Build Type: $build_type"
                echo "# Repository Type: $display_name"
                echo ""
                echo "ç¼–è¯‘æ—¶é—´: $current_time"
                echo "ç¼–è¯‘ç±»å‹: $build_type"
                echo "ä»“åº“ç±»å‹: $display_name"
                echo "æ›´æ–°å†…å®¹:"
                cat "commit_list.tmp"
              } > "${prefix}_updates_001.txt"
              
              rm -f "commit_list.tmp"
              echo "âœ… Updated $display_name records"
            else
              echo "âš ï¸ Failed to clone $display_name repository for record update"
            fi
          }
          
          # Update OP repository records
          update_repo_records "$OP_URL" "$OP_BRANCH" "op" "OP (coolsnowwolf/lede)"
          
          # Update QModem repository records
          update_repo_records "$QMODEM_URL" "$QMODEM_BRANCH" "qmodem" "QModem (FUjr/QModem)"
          
          echo "::endgroup::"

      # ============================================================================
      # Build Configuration Phase
      # ============================================================================
      - name: ğŸ”§ QModem Integration
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ“± QModem Repository Integration"
          
          echo "ğŸ”„ Cloning QModem repository..."
          if git clone "$QMODEM_URL" -b "$QMODEM_BRANCH" qmodem_temp; then
            echo "âœ… Successfully cloned QModem repository"
            
            # Integrate QModem files if needed
            echo "ğŸ“¦ QModem commit information:"
            cd qmodem_temp
            echo "  Commit: $(git rev-parse HEAD)"
            echo "  Author: $(git log -1 --format='%an <%ae>')"
            echo "  Date: $(git log -1 --format='%ci')"
            echo "  Message: $(git log -1 --format='%s')"
            
            # Copy relevant files if they exist
            if [ -d "package" ]; then
              echo "ğŸ“¦ Integrating QModem packages..."
              cp -r package/* ../package/ 2>/dev/null || echo "No packages to copy"
            fi
            
            cd ..
            rm -rf qmodem_temp
          else
            echo "âš ï¸ Failed to clone QModem repository - continuing without it"
          fi
          
          echo "::endgroup::"

      - name: ğŸ½ï¸ Configure Feeds
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ½ï¸ Feed Configuration"
          
          # Load custom feeds configuration if it exists
          if [ -f "$GITHUB_WORKSPACE/$FEEDS_CONF" ]; then
            echo "ğŸ“‹ Loading custom feeds configuration..."
            cp "$GITHUB_WORKSPACE/$FEEDS_CONF" feeds.conf.default
            echo "âœ… Custom feeds configuration loaded"
          else
            echo "ğŸ“‹ Using default feeds configuration"
          fi
          
          # Display feeds configuration
          echo "ğŸ“„ Current feeds configuration:"
          cat feeds.conf.default
          
          echo "::endgroup::"

      - name: ğŸ›ï¸ Install DIY Scripts
        run: |
          echo "::group::ğŸ›ï¸ DIY Script Installation"
          
          # Install DIY script part 1 (before feeds update)
          if [ -f "$DIY_P1_SH" ]; then
            echo "ğŸ”§ Running DIY script part 1..."
            chmod +x "$DIY_P1_SH"
            cd /mnt/workdir/openwrt
            $GITHUB_WORKSPACE/$DIY_P1_SH
            echo "âœ… DIY script part 1 completed"
          else
            echo "ğŸ“ No DIY script part 1 found"
          fi
          
          echo "::endgroup::"

      - name: ğŸ“¦ Update and Install Feeds
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ“¦ Feed Management"
          
          echo "ğŸ”„ Updating feeds..."
          ./scripts/feeds update -a
          
          echo "âš™ï¸ Installing feeds..."
          ./scripts/feeds install -a
          
          ./scripts/feeds install -a -f -p qmodem
          
          echo "ğŸ“Š Feed statistics:"
          ./scripts/feeds list | wc -l | xargs echo "Total packages:"
          
          echo "::endgroup::"

      - name: âš™ï¸ Load Build Configuration
        run: |
          echo "::group::âš™ï¸ Build Configuration"
          
          # Load custom configuration
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“‹ Loading custom build configuration..."
            cp "$CONFIG_FILE" /mnt/workdir/openwrt/.config
            echo "âœ… Custom configuration loaded"
          else
            echo "âš ï¸ No custom configuration found - using defaults"
            echo "CONFIG_TARGET_x86=y" > /mnt/workdir/openwrt/.config
            echo "CONFIG_TARGET_x86_64=y" >> /mnt/workdir/openwrt/.config
          fi
          
          # Run DIY script part 2 (after feeds installation)
          if [ -f "$DIY_P2_SH" ]; then
            echo "ğŸ”§ Running DIY script part 2..."
            chmod +x "$DIY_P2_SH"
            cd /mnt/workdir/openwrt
            $GITHUB_WORKSPACE/$DIY_P2_SH
            echo "âœ… DIY script part 2 completed"
          else
            echo "ğŸ“ No DIY script part 2 found"
          fi
          
          echo "::endgroup::"

      # ============================================================================
      # Build Preparation Phase
      # ============================================================================
      - name: ğŸ“¥ Download Packages
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ“¥ Package Download"
          
          echo "ğŸ”§ Generating final configuration..."
          make defconfig
          
          echo "ğŸ“¦ Downloading packages..."
          make download -j8
          
          # Check for download failures
          find dl -size -1024c -exec ls -l {} \; | tee download_failures.log
          if [ -s download_failures.log ]; then
            echo "âš ï¸ Some packages failed to download:"
            cat download_failures.log
            echo "::warning::Some packages failed to download - build may fail"
          else
            echo "âœ… All packages downloaded successfully"
          fi
          
          echo "ğŸ’¿ Storage usage after download:"
          df -hT $PWD
          
          echo "::endgroup::"

      # ============================================================================
      # Main Build Phase
      # ============================================================================
      - name: ğŸ—ï¸ Compile Firmware
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ—ï¸ Firmware Compilation"
          
          build_start_time=$(date +%s)
          echo "ğŸš€ Starting firmware compilation at $(date)"
          echo "ğŸ”§ Build Type: $BUILD_TYPE"
          
          # Determine build parameters based on type
          case "${{ github.event.inputs.build_type || 'standard' }}" in
            "debug")
              echo "ğŸ› Debug build - single threaded with verbose output"
              make V=s -j1
              ;;
            "minimal")
              echo "âš¡ Minimal build - reduced features"
              make -j$(($(nproc)+1))
              ;;
            *)
              echo "ğŸ­ Standard build - optimized for speed"
              make -j$(($(nproc)+1)) || make -j1 V=s
              ;;
          esac
          
          build_end_time=$(date +%s)
          build_duration=$((build_end_time - build_start_time))
          echo "â±ï¸ Build completed in $(($build_duration / 60)) minutes and $(($build_duration % 60)) seconds"
          
          echo "ğŸ“Š Build statistics:"
          echo "  Start: $(date -d @$build_start_time)"
          echo "  End: $(date -d @$build_end_time)"
          echo "  Duration: $(($build_duration / 60))m $(($build_duration % 60))s"
          
          echo "ğŸ’¿ Final storage usage:"
          df -hT $PWD
          
          echo "::endgroup::"

      # ============================================================================
      # Post-Build Phase
      # ============================================================================
      - name: ğŸ“Š Build Status Check
        id: build_status
        working-directory: /mnt/workdir/openwrt
        run: |
          echo "::group::ğŸ“Š Build Result Analysis"
          
          if [ -d "bin/targets" ]; then
            echo "âœ… Build successful - firmware files generated"
            
            echo "ğŸ“¦ Generated firmware files:"
            find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.vmdk" | head -10
            
            # Count and size of generated files
            file_count=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.vmdk" \) | wc -l)
            total_size=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.vmdk" \) -exec du -c {} + | tail -1 | cut -f1)
            
            echo "ğŸ“ˆ Build summary:"
            echo "  Generated files: $file_count"
            echo "  Total size: $(($total_size / 1024))MB"
            
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Build failed - no firmware files generated"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "::endgroup::"

      - name: ğŸ“¦ Organize Firmware Files
        id: organize
        if: steps.build_status.outputs.status == 'success'
        run: |
          echo "::group::ğŸ“¦ Firmware Organization"
          
          CURRENT_PATH=$(pwd)
          
          # Navigate to firmware directory
          cd /mnt/workdir/openwrt/bin/targets/*/*
          TARGET_PATH=$(pwd)
          echo "ğŸ“‚ Firmware location: ${TARGET_PATH}"
          
          # Clean up packages directory
          rm -rf packages
          
          # Create new version directory
          NEW_VERSION="${FIRMWARE_PREFIX}_$VERSION_LATEST"
          mkdir -p "$NEW_VERSION"
          
          # Move all firmware files to version directory
          mv * "$NEW_VERSION/" 2>/dev/null || true
          
          # Create compressed archive
          echo "ğŸ—œï¸ Creating firmware archive..."
          zip -r "firmware_new.zip" "$NEW_VERSION/"
          
          if [ ! -f "firmware_new.zip" ]; then
            echo "âŒ Failed to create firmware archive"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Prepare archive directory
          cd "$CURRENT_PATH"
          mkdir -p "$ARTIFACT_DIR"
          cd "$ARTIFACT_DIR"
          
          echo "ğŸ“‹ Current firmware files:"
          ls -lh *.zip 2>/dev/null || echo "No existing firmware files"
          
          # Version rotation (oldest <- previous <- current <- new)
          echo "ğŸ”„ Performing version rotation..."
          
          # Move 002 to 003 (if exists)
          if [ -f "${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip" ]; then
            echo "  Moving $VERSION_PREVIOUS â†’ $VERSION_OLDEST"
            mv "${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip" "${FIRMWARE_PREFIX}_$VERSION_OLDEST.zip"
          fi
          
          # Move 001 to 002 (if exists)
          if [ -f "${FIRMWARE_PREFIX}_$VERSION_LATEST.zip" ]; then
            echo "  Moving $VERSION_LATEST â†’ $VERSION_PREVIOUS"
            mv "${FIRMWARE_PREFIX}_$VERSION_LATEST.zip" "${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip"
          fi
          
          # Place new version as 001
          echo "  Installing new version as $VERSION_LATEST"
          cp "${TARGET_PATH}/firmware_new.zip" "${FIRMWARE_PREFIX}_$VERSION_LATEST.zip"
          
          echo "âœ… Final firmware collection:"
          ls -lh *.zip 2>/dev/null || echo "No firmware files found"
          
          # Verify file integrity
          echo "ğŸ” Verifying file integrity..."
          for zip_file in *.zip; do
            if [ -f "$zip_file" ]; then
              if unzip -t "$zip_file" >/dev/null 2>&1; then
                echo "  âœ… $zip_file: OK"
              else
                echo "  âŒ $zip_file: Corrupted - removing"
                rm -f "$zip_file"
              fi
            fi
          done
          
          echo "FIRMWARE=$ARTIFACT_DIR" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      # ============================================================================
      # Release Generation Phase
      # ============================================================================
      - name: ğŸ“ Generate Release Notes
        id: release_note
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
        run: |
          echo "::group::ğŸ“ Release Notes Generation"
          
          OP_OWNER=$(echo "$OP_URL" | cut -d'/' -f4)
          OP_NAME=$(echo "$OP_URL" | cut -d'/' -f5 | cut -d'.' -f1)
          QMODEM_OWNER=$(echo "$QMODEM_URL" | cut -d'/' -f4)
          QMODEM_NAME=$(echo "$QMODEM_URL" | cut -d'/' -f5 | cut -d'.' -f1)
          
          RELEASE_NOTE_FILE="release_notes.md"
          
          {
            echo "# ğŸš€ OpenWrt å›ºä»¶å‘å¸ƒ"
            echo ""
            echo "## ğŸ“‹ æ„å»ºä¿¡æ¯"
            echo ""
            echo "| å±æ€§ | å€¼ |"
            echo "|------|---|"
            echo "| ğŸ·ï¸ æ„å»ºç±»å‹ | \`$BUILD_TYPE\` |"
            echo "| ğŸ“… æ„å»ºæ—¥æœŸ | $(date '+%Y-%m-%d %H:%M:%S %Z') |"
            echo "| ğŸ¯ è§¦å‘æ–¹å¼ | ${{ github.event_name }} |"
            echo "| ğŸ”§ è¿è¡Œç¯å¢ƒ | Ubuntu 22.04 |"
            echo "| ğŸ“¦ å·¥ä½œæµç¨‹ | ${{ github.workflow }} |"
            echo ""
            echo "## ğŸ“ å›ºä»¶ç‰ˆæœ¬"
            echo ""
            
            # Check available firmware versions
            cd "$ARTIFACT_DIR"
            
            if [ -f "${FIRMWARE_PREFIX}_$VERSION_LATEST.zip" ]; then
              latest_size=$(ls -lh "${FIRMWARE_PREFIX}_$VERSION_LATEST.zip" | awk '{print $5}')
              echo "- ğŸ†• **${FIRMWARE_PREFIX}_$VERSION_LATEST.zip** (æœ€æ–°ç‰ˆ) - $latest_size"
            fi
            
            if [ -f "${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip" ]; then
              prev_size=$(ls -lh "${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip" | awk '{print $5}')
              echo "- ğŸ“¦ **${FIRMWARE_PREFIX}_$VERSION_PREVIOUS.zip** (ä¸Šä¸€ç‰ˆ) - $prev_size"
            fi
            
            if [ -f "${FIRMWARE_PREFIX}_$VERSION_OLDEST.zip" ]; then
              old_size=$(ls -lh "${FIRMWARE_PREFIX}_$VERSION_OLDEST.zip" | awk '{print $5}')
              echo "- ğŸ“¦ **${FIRMWARE_PREFIX}_$VERSION_OLDEST.zip** (å­˜æ¡£ç‰ˆ) - $old_size"
            fi
            
            echo ""
            echo "## ğŸ“Š ä»“åº“æ›´æ–°"
            echo ""
            
            cd "$GITHUB_WORKSPACE"
            
            # Function to process update records
            process_update_records() {
              local prefix="$1"
              local display_name="$2"
              local repo_url="$3"
              
              echo "### ğŸ”§ $display_name"
              echo ""
              
              if [ -f "${prefix}_updates_001.txt" ]; then
                echo "#### ğŸ“ æœ€æ–°æ›´æ–° (${FIRMWARE_PREFIX}_$VERSION_LATEST)"
                echo ""
                
                # Skip header lines and process commit records
                while IFS= read -r line; do
                  if [[ $line == "ç¼–è¯‘æ—¶é—´:"* ]] || [[ $line == "ç¼–è¯‘ç±»å‹:"* ]] || [[ $line == "ä»“åº“ç±»å‹:"* ]]; then
                    continue
                  elif [[ $line == "æ›´æ–°å†…å®¹:" ]]; then
                    echo "**æäº¤å†å²:**"
                    echo ""
                  else
                    if [[ $line =~ ^[a-f0-9]{40}\|[a-f0-9]{7}\| ]]; then
                      IFS='|' read -r full_hash short_hash subject author timestamp <<< "$line"
                      if [ -n "$short_hash" ] && [ -n "$subject" ]; then
                        echo "- [\`$short_hash\`]($repo_url/commit/$full_hash) $subject - *$author*"
                      fi
                    fi
                  fi
                done < "${prefix}_updates_001.txt"
                echo ""
              else
                echo "*æ— å¯ç”¨çš„æ›´æ–°è®°å½•*"
                echo ""
              fi
            }
            
            # Process OP repository updates
            process_update_records "op" "OP Repository (coolsnowwolf/lede)" "$OP_URL"
            
            # Process QModem repository updates
            process_update_records "qmodem" "QModem Repository (FUjr/QModem)" "$QMODEM_URL"
            
            echo "## ğŸ’¾ å®‰è£…è¯´æ˜"
            echo ""
            echo "1. **ä¸‹è½½** é€‚åˆæ‚¨è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶"
            echo "2. **å¤‡ä»½** å½“å‰é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰"
            echo "3. **åˆ·å†™** ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ·å…¥å›ºä»¶ï¼š"
            echo "   - ç½‘é¡µç•Œé¢å‡çº§"
            echo "   - TFTP æ¢å¤"
            echo "   - ä¸²å£æ§åˆ¶å°"
            echo "4. **é…ç½®** é¦–æ¬¡å¯åŠ¨åé…ç½®è®¾å¤‡"
            echo ""
            echo "## âš ï¸ é‡è¦æç¤º"
            echo ""
            echo "- è¿™æ˜¯ä¸€ä¸ª **å¼€å‘ç‰ˆæœ¬** - ä½¿ç”¨é£é™©è‡ªè´Ÿ"
            echo "- å‡çº§å‰åŠ¡å¿…å¤‡ä»½å½“å‰å›ºä»¶"
            echo "- åˆ·æœºå‰è¯·æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§"
            echo "- åœ¨ä¸»è¦ç‰ˆæœ¬ä¹‹é—´å‡çº§æ—¶å¯èƒ½éœ€è¦æ¢å¤å‡ºå‚è®¾ç½®"
            echo ""
            echo "---"
            echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆäº $(date '+%Y-%m-%d %H:%M:%S %Z')*"
            
          } > "$RELEASE_NOTE_FILE"
          
          echo "âœ… Release notes generated successfully"
          echo "release_note=$RELEASE_NOTE_FILE" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      # ============================================================================
      # Upload Phase
      # ============================================================================
      - name: ğŸ“¤ Upload Firmware Artifacts
        if: env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_PREFIX }}_firmware_${{ env.BUILD_TYPE }}_$(date +%Y%m%d_%H%M%S)
          path: ${{ env.ARTIFACT_DIR }}/*.zip
          retention-days: 30
          compression-level: 0  # Files are already compressed

      - name: ğŸ¯ Create GitHub Release
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success'
        run: |
          echo "::group::ğŸ¯ GitHub Release Creation"
          
          # Generate release metadata
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          TAG_NAME="${{ env.RELEASE_TAG }}_${TIMESTAMP}"
          RELEASE_NAME="ğŸš€ OpenWrt Firmware - $(date +%Y-%m-%d)"
          
          echo "ğŸ“‹ Release Information:"
          echo "  Tag: $TAG_NAME"
          echo "  Name: $RELEASE_NAME"
          echo "  Prerelease: ${{ env.BUILD_TYPE == 'debug' }}"
          
          # Create release
          echo "ğŸš€ Creating GitHub release..."
          if [ "${{ env.BUILD_TYPE }}" = "debug" ]; then
            PRERELEASE_FLAG="--prerelease"
          else
            PRERELEASE_FLAG=""
          fi
          
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes-file "${{ steps.release_note.outputs.release_note }}" \
            $PRERELEASE_FLAG \
            ${{ env.ARTIFACT_DIR }}/*.zip
          
          echo "âœ… Release created successfully: $TAG_NAME"
          echo "::endgroup::"
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}

      # ============================================================================
      # Configuration Commit Phase
      # ============================================================================
      - name: ğŸ’¾ Commit Configuration Updates
        if: always() && !cancelled()
        run: |
          echo "::group::ğŸ’¾ Configuration Updates"
          
          # Setup git configuration
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions [Build Bot]"
          
          # Clean up conflicting files and stash changes
          echo "ğŸ§¹ Cleaning up conflicting files..."
          if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "ğŸ’¾ Stashing uncommitted changes..."
            git stash push -m "Auto-stash before config branch operations"
          fi
          
          # Remove any conflicting tracking files from working directory
          rm -f op_updates_*.txt qmodem_updates_*.txt *_last_commit.txt 2>/dev/null || true
          
          # Check out or create config branch
          if git rev-parse --verify origin/$CONFIG_BRANCH >/dev/null 2>&1; then
            git fetch origin $CONFIG_BRANCH
            git checkout $CONFIG_BRANCH
          else
            git checkout --orphan $CONFIG_BRANCH
            git rm -rf . 2>/dev/null || true
            echo "# Configuration Storage Branch" > README.md
            echo "This branch stores configuration files for the workflows." >> README.md
            git add README.md
            git commit -m "ğŸ¯ Initialize configuration storage branch"
          fi
          
          # Copy updated config files to config branch
          git checkout ${{ github.ref_name }}
          for file in op_updates_*.txt qmodem_updates_*.txt; do
            if [ -f "$file" ]; then
              cp "$file" /tmp/"$file"
            fi
          done
          
          git checkout $CONFIG_BRANCH
          for file in op_updates_*.txt qmodem_updates_*.txt; do
            if [ -f "/tmp/$file" ]; then
              cp "/tmp/$file" "$file"
            fi
          done
          
          # Add and commit configuration files
          git add *.txt
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No configuration changes to commit"
          else
            echo "ğŸ“ Committing configuration updates..."
            
            # Create detailed commit message
            commit_msg="ğŸ—ï¸ Update build configuration records

            Build Information:
            - Type: $BUILD_TYPE
            - Trigger: ${{ github.event_name }}
            - Status: ${{ steps.build_status.outputs.status || 'unknown' }}
            - Date: $(date -Iseconds)
            
            Updated Files:
            $(git diff --staged --name-only | sed 's/^/- /')
            
            Auto-generated by: ${{ github.workflow }} #${{ github.run_number }}"
            
            git commit -m "$commit_msg"
            git push origin $CONFIG_BRANCH
            
            echo "âœ… Configuration updates committed and pushed to config branch"
          fi
          
          echo "::endgroup::"

      # ============================================================================
      # Cleanup and Summary Phase
      # ============================================================================
      - name: ğŸ§¹ Cleanup and Maintenance
        if: always()
        run: |
          echo "::group::ğŸ§¹ Cleanup Operations"
          
          # Clean up temporary directories
          echo "ğŸ—‘ï¸ Cleaning temporary files..."
          rm -rf /tmp/openwrt_* 2>/dev/null || true
          
          # Clean up old workflow runs (keep last 10)
          echo "ğŸ“Š Workflow cleanup will be handled by retention settings"
          
          # Show final disk usage
          echo "ğŸ’¿ Final disk usage:"
          df -hT / | head -2
          
          echo "::endgroup::"

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "# ğŸ—ï¸ OpenWrt æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ„å»ºçŠ¶æ€
          echo "## ğŸ“Š æ„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build_status.outputs.status }}" = "success" ]; then
            echo "### âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å›ºä»¶å·²æˆåŠŸç¼–è¯‘å®Œæˆï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ„å»ºè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ„å»ºä¿¡æ¯
          echo "## ğŸ“‹ æ„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å±æ€§ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ æ„å»ºç±»å‹ | $BUILD_TYPE |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… æ„å»ºæ—¥æœŸ | $(date '+%Y-%m-%d %H:%M:%S %Z') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ ä»£ç ä»“åº“ | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ å·¥ä½œæµç¨‹ | ${{ github.workflow }} #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç”Ÿæˆçš„æ–‡ä»¶
          if [ "${{ steps.organize.outputs.status }}" = "success" ]; then
            echo "## ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å·²ç”Ÿæˆä»¥ä¸‹å›ºä»¶æ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cd "$ARTIFACT_DIR" 2>/dev/null || cd .
            for zip_file in *.zip 2>/dev/null; do
              if [ -f "$zip_file" ]; then
                file_size=$(ls -lh "$zip_file" | awk '{print $5}')
                echo "- ğŸ“ \`$zip_file\` ($file_size)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ä¸‹ä¸€æ­¥æ“ä½œ
          echo "## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$UPLOAD_RELEASE" = "true" ] && [ "${{ steps.organize.outputs.status }}" = "success" ]; then
            echo "1. ğŸ“¥ **ä¸‹è½½** ä»å‘å¸ƒé¡µé¢ä¸‹è½½å›ºä»¶" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ” **éªŒè¯** å›ºä»¶å®Œæ•´æ€§" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ“± **åˆ·å†™** æŒ‰ç…§æ­£ç¡®æ­¥éª¤åˆ·å…¥è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
          elif [ "$UPLOAD_FIRMWARE" = "true" ] && [ "${{ steps.organize.outputs.status }}" = "success" ]; then
            echo "1. ğŸ“¥ **ä¸‹è½½** ä»å·¥ä»¶åŒºåŸŸä¸‹è½½å›ºä»¶" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ” **éªŒè¯** å›ºä»¶å®Œæ•´æ€§" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ“± **åˆ·å†™** æŒ‰ç…§æ­£ç¡®æ­¥éª¤åˆ·å…¥è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- æ„å»ºå®Œæˆï¼Œä½†æœªå¯ç”¨ä¸Šä¼ åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ„å»ºå®Œæˆæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S %Z')*" >> $GITHUB_STEP_SUMMARY
